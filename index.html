<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>소리 파동 가상 실험실</title>
    <!-- PWA Manifest 연결 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4F46E5">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons UMD build for browser support -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
</head>
<body class="bg-gray-50 font-sans select-none">
    <div class="flex flex-col items-center justify-center w-full min-h-screen p-4 md:p-6">
        <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden">
            <!-- Header -->
            <div class="bg-indigo-600 p-6 text-white flex flex-col xl:flex-row justify-between items-center gap-6">
                <div>
                    <h1 class="text-2xl font-bold flex items-center gap-2 whitespace-nowrap">
                        <i data-lucide="activity" class="w-8 h-8"></i>
                        소리 파동 가상 실험실
                    </h1>
                    <p class="text-indigo-200 mt-1">주파수, 진폭, 파형을 조절하며 소리를 눈으로 확인하세요.</p>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 items-center bg-indigo-700/30 p-2 rounded-2xl">
                    <!-- Visual Tools Group -->
                    <div class="flex gap-2">
                        <button id="guideBtn" class="flex items-center gap-2 px-4 py-2.5 rounded-xl font-bold transition-all transform hover:scale-105 shadow-lg bg-purple-400 hover:bg-purple-500 text-white text-sm whitespace-nowrap">
                            <i data-lucide="scan-line" class="w-4 h-4 icon-guide"></i>
                            <span id="guideBtnText">점선 보기</span>
                        </button>
                        <button id="velocityBtn" class="flex items-center gap-2 px-4 py-2.5 rounded-xl font-bold transition-all transform hover:scale-105 shadow-lg bg-pink-400 hover:bg-pink-500 text-white text-sm whitespace-nowrap">
                            <i data-lucide="move-right" class="w-4 h-4 icon-velocity"></i>
                            <span id="velocityBtnText">속도 화살표</span>
                        </button>
                    </div>

                    <!-- Divider -->
                    <div class="hidden sm:block w-px h-8 bg-indigo-400/50"></div>

                    <!-- Control Group -->
                    <div class="flex gap-2">
                        <button id="animBtn" class="flex items-center gap-2 px-4 py-2.5 rounded-xl font-bold transition-all transform hover:scale-105 shadow-lg bg-yellow-400 hover:bg-yellow-500 text-yellow-900 text-sm whitespace-nowrap">
                            <i data-lucide="pause" class="w-4 h-4 icon-anim"></i>
                            <span id="animBtnText">정지</span>
                        </button>
                        <button id="playBtn" class="flex items-center gap-2 px-4 py-2.5 rounded-xl font-bold transition-all transform hover:scale-105 shadow-lg bg-green-400 hover:bg-green-500 text-indigo-900 text-sm whitespace-nowrap">
                            <i data-lucide="play" class="w-4 h-4 icon-state"></i>
                            <span id="playBtnText">소리 켜기</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">

                <!-- Controls Section -->
                <div class="lg:col-span-1 space-y-8 bg-gray-50 p-6 rounded-xl border border-gray-200">

                    <!-- Frequency Control -->
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <label class="text-gray-700 font-bold flex items-center gap-2 whitespace-nowrap">
                                <i data-lucide="activity" class="w-4 h-4 text-indigo-600"></i>
                                주파수 (진동수)
                            </label>
                            <span id="freqValue" class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-mono font-bold whitespace-nowrap">
                                440 Hz
                            </span>
                        </div>
                        <input id="freqInput" type="range" min="100" max="1000" step="10" value="440" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                        <div class="flex justify-between text-xs text-gray-400 px-1">
                            <span>100Hz</span>
                            <span>1000Hz</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            주파수가 높을수록 <strong>높은 음(고음)</strong>이 나고, 파동이 촘촘해집니다.
                        </p>
                    </div>

                    <!-- Amplitude Control -->
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <label class="text-gray-700 font-bold flex items-center gap-2 whitespace-nowrap">
                                <i data-lucide="volume-2" class="w-4 h-4 text-emerald-600"></i>
                                진폭 (소리 크기)
                            </label>
                            <span id="ampValue" class="bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full text-sm font-mono font-bold whitespace-nowrap">
                                50 %
                            </span>
                        </div>
                        <input id="ampInput" type="range" min="0" max="1" step="0.01" value="0.5" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-emerald-600">
                        <p class="text-xs text-gray-500">
                            진폭이 클수록 <strong>큰 소리</strong>가 나고, 파동의 높이가 높아집니다.
                        </p>
                    </div>

                    <!-- Wave Type Control -->
                    <div class="space-y-3">
                        <label class="text-gray-700 font-bold flex items-center gap-2 whitespace-nowrap">
                            <i data-lucide="zap" class="w-4 h-4 text-yellow-600"></i>
                            파형 (음색)
                        </label>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-2" id="waveTypeContainer">
                            <button data-type="sine" class="wave-btn px-3 py-2 text-sm rounded-lg border transition-colors bg-indigo-600 text-white border-indigo-600 whitespace-nowrap">사인파 (Sine)</button>
                            <button data-type="square" class="wave-btn px-3 py-2 text-sm rounded-lg border transition-colors bg-white text-gray-600 border-gray-300 hover:bg-gray-50 whitespace-nowrap">사각형파 (Square)</button>
                            <button data-type="sawtooth" class="wave-btn px-3 py-2 text-sm rounded-lg border transition-colors bg-white text-gray-600 border-gray-300 hover:bg-gray-50 whitespace-nowrap">톱니파 (Saw)</button>
                            <button data-type="triangle" class="wave-btn px-3 py-2 text-sm rounded-lg border transition-colors bg-white text-gray-600 border-gray-300 hover:bg-gray-50 whitespace-nowrap">삼각파 (Triangle)</button>
                        </div>
                        <p class="text-xs text-gray-500">
                            파형의 모양이 달라지면 소리의 <strong>맵시(음색)</strong>가 변합니다.
                        </p>
                    </div>

                </div>

                <!-- Visualization Section -->
                <div class="lg:col-span-2 space-y-6">

                    <!-- Graph 1: Displacement-Time -->
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4 relative group">
                        <div class="absolute top-4 left-4 bg-white/90 backdrop-blur px-3 py-1.5 rounded-lg text-xs font-bold text-gray-600 border border-gray-200 shadow-sm z-10">
                            변위-시간 그래프 (횡파적 표현)
                        </div>
                        <canvas id="waveCanvas" class="w-full h-[250px] bg-white rounded-lg cursor-crosshair"></canvas>
                    </div>

                    <!-- Graph 2: Particle Model -->
                    <div class="bg-gray-900 rounded-xl border border-gray-800 shadow-sm p-4 relative">
                        <div class="mb-2 inline-block bg-gray-800/90 backdrop-blur px-3 py-1.5 rounded-lg text-xs font-bold text-gray-300 border border-gray-700 shadow-sm">
                            입자 모형 (종파 - 실제 소리의 전달)
                        </div>
                        <canvas id="particleCanvas" class="w-full h-[150px] bg-transparent rounded-lg"></canvas>
                        <div class="mt-2 text-xs text-gray-400 text-center">
                            * 소리는 공기 입자가 빽빽해졌다(밀) 듬성해졌다(소) 하며 전달됩니다.
                        </div>
                    </div>

                    <!-- Info Box -->
                    <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 flex gap-3">
                        <i data-lucide="info" class="w-6 h-6 text-blue-500 flex-shrink-0 mt-0.5"></i>
                        <div class="text-sm text-blue-800">
                            <p class="font-bold mb-1">실험 가이드:</p>
                            <ul class="list-disc pl-4 space-y-1">
                                <li><strong>주파수(Hz)</strong>를 높이면 그래프의 파동 간격이 좁아지고 음이 높아집니다.</li>
                                <li><strong>진폭</strong>을 높이면 그래프의 위아래 높이가 커지고 소리가 커집니다.</li>
                                <li><strong>점선 보기</strong>를 켜면 횡파의 진폭이 0인 지점이 종파의 <span class="text-red-500 font-bold">밀(빽빽함)</span>과 <span class="text-blue-500 font-bold">소(듬성함)</span>로 연결되는 것을 볼 수 있습니다.</li>
                                <li><strong>속도 화살표</strong>를 켜면 첫 번째 줄 특정 입자의 순간 속도를 붉은색 화살표로 확인할 수 있습니다.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let isPlaying = false;
        let isAnimating = true;
        let showGuides = false; 
        let showVelocity = false; 
        let frequency = 440;
        let amplitude = 0.5;
        let waveType = 'sine';
        let animationId;

        // Audio Context
        let audioContext = null;
        let oscillator = null;
        let gainNode = null;

        // --- DOM Elements ---
        const playBtn = document.getElementById('playBtn');
        const playBtnText = document.getElementById('playBtnText');
        const playBtnIcon = playBtn.querySelector('.icon-state');

        const animBtn = document.getElementById('animBtn');
        const animBtnText = document.getElementById('animBtnText');
        const animBtnIcon = animBtn.querySelector('.icon-anim');

        const guideBtn = document.getElementById('guideBtn');
        const guideBtnText = document.getElementById('guideBtnText');
        const guideBtnIcon = guideBtn.querySelector('.icon-guide');

        const velocityBtn = document.getElementById('velocityBtn');
        const velocityBtnText = document.getElementById('velocityBtnText');

        const freqInput = document.getElementById('freqInput');
        const freqValue = document.getElementById('freqValue');

        const ampInput = document.getElementById('ampInput');
        const ampValue = document.getElementById('ampValue');

        const waveCanvas = document.getElementById('waveCanvas');
        const particleCanvas = document.getElementById('particleCanvas');

        const waveBtns = document.querySelectorAll('.wave-btn');

        // --- Resize Handling ---
        function resizeCanvas() {
            const waveContainer = waveCanvas.parentElement;
            const particleContainer = particleCanvas.parentElement;

            waveCanvas.width = waveContainer.clientWidth;
            waveCanvas.height = 250; // Fixed height

            particleCanvas.width = particleContainer.clientWidth;
            particleCanvas.height = 150; // Fixed height
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- Logic ---

        function updateUI() {
            freqValue.innerText = frequency + ' Hz';
            ampValue.innerText = Math.round(amplitude * 100) + ' %';

            if (oscillator && audioContext) {
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = waveType;
            }
            if (gainNode && audioContext) {
                gainNode.gain.setTargetAtTime(amplitude, audioContext.currentTime, 0.02);
            }
        }

        function updateWaveBtns() {
            waveBtns.forEach(btn => {
                if (btn.dataset.type === waveType) {
                    btn.className = 'wave-btn px-3 py-2 text-sm rounded-lg border transition-colors bg-indigo-600 text-white border-indigo-600 font-bold shadow-sm whitespace-nowrap';
                } else {
                    btn.className = 'wave-btn px-3 py-2 text-sm rounded-lg border transition-colors bg-white text-gray-600 border-gray-300 hover:bg-gray-50 hover:text-indigo-600 whitespace-nowrap';
                }
            });
        }

        // --- Audio Functions ---

        function startSound() {
            const AudioContextClass = window.AudioContext || window.webkitAudioContext;
            if (!audioContext) {
                audioContext = new AudioContextClass();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            oscillator = audioContext.createOscillator();
            gainNode = audioContext.createGain();

            oscillator.type = waveType;
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            gainNode.gain.setValueAtTime(amplitude, audioContext.currentTime);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.start();

            isPlaying = true;
            updatePlayButton();
        }

        function stopSound() {
            if (oscillator) {
                const currentTime = audioContext.currentTime;
                gainNode.gain.linearRampToValueAtTime(0, currentTime + 0.05);
                oscillator.stop(currentTime + 0.05);

                setTimeout(() => {
                    if (oscillator) oscillator.disconnect();
                    if (gainNode) gainNode.disconnect();
                    oscillator = null;
                }, 100);
            }

            isPlaying = false;
            updatePlayButton();
        }

        function togglePlay() {
            if (isPlaying) stopSound();
            else startSound();
        }

        function updatePlayButton() {
            if (isPlaying) {
                playBtn.className = 'flex items-center gap-2 px-4 py-2.5 rounded-xl font-bold transition-all transform hover:scale-105 shadow-lg bg-red-500 hover:bg-red-600 text-white text-sm whitespace-nowrap';
                playBtnText.innerText = '소리 끄기';
                playBtnIcon.setAttribute('data-lucide', 'volume-x');
            } else {
                playBtn.className = 'flex items-center gap-2 px-4 py-2.5 rounded-xl font-bold transition-all transform hover:scale-105 shadow-lg bg-green-400 hover:bg-green-500 text-indigo-900 text-sm whitespace-nowrap';
                playBtnText.innerText = '소리 켜기';
                playBtnIcon.setAttribute('data-lucide', 'play');
            }
            if (window.lucide) lucide.createIcons();
        }

        function toggleAnimation() {
            isAnimating = !isAnimating;
            if (isAnimating) {
                animBtn.className = 'flex items-center gap-2 px-4 py-2.5 rounded-xl font-bold transition-all transform hover:scale-105 shadow-lg bg-yellow-400 hover:bg-yellow-500 text-yellow-900 text-sm whitespace-nowrap';
                animBtnText.innerText = '정지';
                animBtnIcon.setAttribute('data-lucide', 'pause');
            } else {
                animBtn.className = 'flex items-center gap-2 px-4 py-2.5 rounded-xl font-bold transition-all transform hover:scale-105 shadow-lg bg-blue-400 hover:bg-blue-500 text-white text-sm whitespace-nowrap';
                animBtnText.innerText = '재생';
                animBtnIcon.setAttribute('data-lucide', 'play');
            }
            if (window.lucide) lucide.createIcons();
        }

        function toggleGuides() {
            showGuides = !showGuides;
            if (showGuides) {
                guideBtn.className = 'flex items-center gap-2 px-4 py-2.5 rounded-xl font-bold transition-all transform hover:scale-105 shadow-lg bg-purple-600 hover:bg-purple-700 text-white text-sm ring-2 ring-purple-300 whitespace-nowrap';
                guideBtnText.innerText = '점선 숨기기';
            } else {
                guideBtn.className = 'flex items-center gap-2 px-4 py-2.5 rounded-xl font-bold transition-all transform hover:scale-105 shadow-lg bg-purple-400 hover:bg-purple-500 text-white text-sm whitespace-nowrap';
                guideBtnText.innerText = '점선 보기';
            }
        }

        function toggleVelocity() {
            showVelocity = !showVelocity;
            if (showVelocity) {
                velocityBtn.className = 'flex items-center gap-2 px-4 py-2.5 rounded-xl font-bold transition-all transform hover:scale-105 shadow-lg bg-pink-600 hover:bg-pink-700 text-white text-sm ring-2 ring-pink-300 whitespace-nowrap';
                velocityBtnText.innerText = '화살표 숨기기';
            } else {
                velocityBtn.className = 'flex items-center gap-2 px-4 py-2.5 rounded-xl font-bold transition-all transform hover:scale-105 shadow-lg bg-pink-400 hover:bg-pink-500 text-white text-sm whitespace-nowrap';
                velocityBtnText.innerText = '속도 화살표';
            }
        }

        function getWaveY(waveType, angle) { 
             if (waveType === 'sine') return Math.sin(angle);
             if (waveType === 'square') return Math.sin(angle) > 0 ? 1 : -1;
             if (waveType === 'sawtooth') {
                const period = 2 * Math.PI;
                return ((angle % period + period) % period) / period * 2 - 1;
             }
             if (waveType === 'triangle') {
                const period = 2 * Math.PI;
                return Math.abs(((angle % period + period) % period) / period * 2 - 1) * 2 - 1;
             }
             return 0;
        }

        function getWaveVelocityFactor(waveType, angle) {
            const twoPi = 2 * Math.PI;
            const normAngle = (angle % twoPi + twoPi) % twoPi;

            if (waveType === 'sine') return -Math.cos(angle);
            if (waveType === 'triangle') return (normAngle < Math.PI) ? (2 / Math.PI) : (-2 / Math.PI);
            if (waveType === 'sawtooth') return -1 / Math.PI;
            if (waveType === 'square') return 0;
            return 0;
        }

        // --- Animation Loop ---
        let phase = 0;

        function draw() {
            const k = 0.01 * (frequency / 200);
            if (isAnimating) phase += frequency * 0.00005;

            // --- Draw Graph 1: Transverse Wave ---
            const ctx = waveCanvas.getContext('2d');
            const width = waveCanvas.width;
            const height = waveCanvas.height;
            ctx.clearRect(0, 0, width, height);

            ctx.beginPath();
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            ctx.moveTo(0, height / 2);
            ctx.lineTo(width, height / 2);
            ctx.stroke();

            ctx.beginPath();
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#4F46E5'; 

            const visualAmp = (amplitude * height) / 2.2; 
            const step = 2;

            const guideLines = [];
            let prevY = getWaveY(waveType, -phase) * visualAmp;

            for (let x = 0; x <= width; x += step) {
                const angle = x * k - phase;
                const y = getWaveY(waveType, angle) * visualAmp;

                if (x === 0) ctx.moveTo(x, height / 2 - y);
                else ctx.lineTo(x, height / 2 - y);

                if (showGuides && prevY * y <= 0 && Math.abs(prevY - y) < visualAmp) {
                    const slope = y - prevY;
                    const type = slope < 0 ? 'compression' : 'rarefaction';
                    guideLines.push({ x: x, type: type });
                }
                prevY = y;
            }
            ctx.stroke();

            if (showGuides) {
                ctx.save();
                ctx.setLineDash([4, 4]);
                ctx.lineWidth = 1.5; 
                guideLines.forEach(line => {
                    ctx.beginPath();
                    ctx.strokeStyle = line.type === 'compression' ? 'rgba(239, 68, 68, 0.6)' : 'rgba(59, 130, 246, 0.6)'; 
                    ctx.moveTo(line.x, 0);
                    ctx.lineTo(line.x, height);
                    ctx.stroke();

                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(line.x - 7, 4, 14, 14);

                    ctx.fillStyle = line.type === 'compression' ? 'rgba(239, 68, 68, 1)' : 'rgba(59, 130, 246, 1)'; 
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(line.type === 'compression' ? '밀' : '소', line.x, 15);
                });
                ctx.restore();
            }

            // --- Draw Graph 2: Particle System (Longitudinal) ---
            const pCtx = particleCanvas.getContext('2d');
            const pWidth = particleCanvas.width;
            const pHeight = particleCanvas.height;
            pCtx.clearRect(0, 0, pWidth, pHeight);

            if (showGuides) {
                pCtx.save();
                pCtx.setLineDash([4, 4]);
                pCtx.lineWidth = 1.5;
                guideLines.forEach(line => {
                    pCtx.beginPath();
                    pCtx.strokeStyle = line.type === 'compression' ? 'rgba(239, 68, 68, 0.4)' : 'rgba(59, 130, 246, 0.4)';
                    pCtx.moveTo(line.x, 0);
                    pCtx.lineTo(line.x, pHeight);
                    pCtx.stroke();
                });
                pCtx.restore();
            }

            const rows = 5;
            const cols = Math.floor(pWidth / 15);
            const spacingX = pWidth / cols;
            const spacingY = pHeight / (rows + 1);

            const targetRow = 0; 
            const targetCol = Math.floor(cols / 2);

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c <= cols; c++) {
                    const baseX = c * spacingX;
                    const baseY = (r + 1) * spacingY;

                    const maxDisplacement = spacingX * 1.2;
                    const angle = baseX * k - phase;
                    const waveVal = getWaveY(waveType, angle);
                    const displacement = waveVal * (amplitude * maxDisplacement);

                    pCtx.fillStyle = (c % 2 === 0) ? '#10B981' : '#F59E0B'; 
                    const px = baseX + displacement;
                    const py = baseY;

                    pCtx.beginPath();
                    pCtx.arc(px, py, 3, 0, Math.PI * 2);
                    pCtx.fill();

                    if (showVelocity && r === targetRow && c === targetCol) {
                        const velFactor = getWaveVelocityFactor(waveType, angle);
                        const velScale = 1.5 * Math.sqrt(frequency);
                        const velVector = velFactor * amplitude * velScale;

                        pCtx.save();
                        pCtx.strokeStyle = '#E11D48';
                        pCtx.fillStyle = '#E11D48';
                        pCtx.lineWidth = 2;

                        pCtx.beginPath();
                        pCtx.moveTo(px, py - 12);
                        pCtx.lineTo(px + velVector, py - 12);
                        pCtx.stroke();

                        if (Math.abs(velVector) > 2) {
                            const headSize = 4;
                            const dir = velVector > 0 ? 1 : -1;
                            const endX = px + velVector;
                            const endY = py - 12;
                            pCtx.beginPath();
                            pCtx.moveTo(endX, endY);
                            pCtx.lineTo(endX - headSize * dir, endY - headSize);
                            pCtx.lineTo(endX - headSize * dir, endY + headSize);
                            pCtx.fill();
                        }

                        pCtx.restore();

                        pCtx.beginPath();
                        pCtx.strokeStyle = '#E11D48';
                        pCtx.lineWidth = 2;
                        pCtx.arc(px, py, 5, 0, Math.PI * 2);
                        pCtx.stroke();
                    }
                }
            }

            animationId = requestAnimationFrame(draw);
        }

        // --- Event Listeners ---
        playBtn.addEventListener('click', togglePlay);
        animBtn.addEventListener('click', toggleAnimation);
        guideBtn.addEventListener('click', toggleGuides);
        velocityBtn.addEventListener('click', toggleVelocity);

        freqInput.addEventListener('input', (e) => { frequency = Number(e.target.value); updateUI(); });
        ampInput.addEventListener('input', (e) => { amplitude = Number(e.target.value); updateUI(); });

        waveBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                waveType = btn.dataset.type;
                updateWaveBtns();
                updateUI();
            });
        });

        window.onload = () => {
            if (window.lucide) lucide.createIcons();
            draw();
            resizeCanvas();
        };
    </script>

    <!-- Service Worker 등록 (PWA) -->
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("./sw.js").catch(console.error);
        });
      }
    </script>
</body>
</html>
